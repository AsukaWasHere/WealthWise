<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Financial Advisor - WealthWise AI</title>
    <link rel="stylesheet" href="../css/main.css" />
</head>
<body class="bg-background text-text-primary">
    
    <section class="py-20 bg-white">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="step-3" class="assessment-step hidden">
                <div class="card max-w-2xl mx-auto">
                    <div class="flex justify-between mt-8">
                        <button onclick="prevStep()" class="btn-secondary">Back</button>
                        <button onclick="submitAssessment()" class="btn-primary">Generate Portfolio</button>
                    </div>
                </div>
            </div>

            <div id="step-4" class="assessment-step hidden">
                <div id="analysis-results" class="space-y-8">
                    <div id="loading-spinner" class="text-center">
                        <p class="text-lg">AI is Analyzing Your Profile...</p>
                    </div>
                    <div id="results-content" class="hidden"></div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // (Your existing JavaScript for UI interactions like nextStep, prevStep, etc.)

        // --- New Script for API Interaction ---
        const backendUrl = 'http://127.0.0.1:8000'; // Change to your deployed backend URL

        async function submitAssessment() {
            nextStep();
            document.getElementById('loading-spinner').style.display = 'block';
            document.getElementById('results-content').style.display = 'none';

            const incomeMap = { "under-50k": 40000, "50k-75k": 62500, "75k-100k": 87500, "100k-150k": 125000, "150k-250k": 200000, "250k+": 300000 };
            const savingsMap = { "under-10k": 5000, "10k-25k": 17500, "25k-50k": 37500, "50k-100k": 75000, "100k-250k": 175000, "250k+": 300000 };
            const riskValue = document.getElementById('risk-slider').value;
            const riskText = {1: "Conservative", 2: "Moderate Conservative", 3: "Moderate", 4: "Moderate Aggressive", 5: "Aggressive"}[riskValue];

            const userProfile = {
                age: parseInt(document.getElementById('age-range').value.split('-')[0]),
                income: incomeMap[document.getElementById('annual-income').value],
                current_savings: savingsMap[document.getElementById('current-savings').value],
                investment_experience: document.getElementById('investment-experience').value,
                monthly_budget: parseFloat(document.getElementById('monthly-budget').value),
                goals: selectedGoals,
                investment_timeline: 15, // Example, link to your form
                risk_tolerance: riskText
            };

            try {
                const response = await fetch(`${backendUrl}/api/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userProfile),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                displayResults(data.insight);
            } catch (error) {
                console.error('Error fetching analysis:', error);
                displayError();
            }
        }

        function displayResults(insight) {
            const resultsContainer = document.getElementById('results-content');
            let allocationHTML = '<ul class="grid grid-cols-2 gap-4">';
            for (const [asset, percent] of Object.entries(insight.risk_allocation)) {
                allocationHTML += `<li class="flex justify-between p-2 bg-gray-100 rounded"><strong>${asset}:</strong> ${percent}%</li>`;
            }
            allocationHTML += '</ul>';
            
            resultsContainer.innerHTML = `
                <div class="text-center"><h2 class="text-3xl font-bold mb-4">Your Analysis</h2></div>
                <div class="card mt-8"><h3 class="text-xl font-semibold mb-4">AI Summary</h3><p>${insight.summary}</p></div>
                <div class="card mt-6"><h3 class="text-xl font-semibold mb-4">Allocation</h3>${allocationHTML}</div>
                <div class="card mt-6"><h3 class="text-xl font-semibold mb-4">Risk Profile</h3><img src="${insight.graph}" alt="Risk Profile" class="mx-auto"/></div>
            `;
            document.getElementById('loading-spinner').style.display = 'none';
            resultsContainer.style.display = 'block';
        }
        
        function displayError() {
            const resultsContainer = document.getElementById('results-content');
            resultsContainer.innerHTML = '<div class="text-center text-red-500 card"><h2 class="text-2xl">Analysis Failed</h2><p>Could not retrieve analysis. Please try again later.</p></div>';
            document.getElementById('loading-spinner').style.display = 'none';
            resultsContainer.style.display = 'block';
        }
    </script>
</body>
</html>
